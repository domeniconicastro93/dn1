const fs=require("fs");let s=fs.readFileSync(__dirname+"/../src/webrtc-peer.ts","utf8");s=s.replace(/import.*capture-provider.*;?\s*\n?/g,"");if(!s.includes("native_capture")){const i=s.lastIndexOf("import ");s=s.slice(0,s.indexOf("\n",i)+1)+"const nativeCapture=require(\"../../native_capture.node\");\n"+s.slice(s.indexOf("\n",i)+1)}s=s.replace(/private captureProvider.*/g,"");s=s.replace(/FFmpeg/g,"Native WGC");const badStart=/console\.log\(\`\[WebRTCPeer\]\[\$\{sessionId\}\] .*? Starting capture\.\.\.\`\);\s*\nprivate startCapture\(\):.*?\n}\s*\n/s;s=s.replace(badStart,"console.log(`[WebRTCPeer][${sessionId}] WebRTC connected! Starting capture...`);\n                this.startCapture();\n");function findMethodLine(t,m){const lines=t.split("\n");for(let i=0;i<lines.length;i++){if(lines[i].match(new RegExp("^\\s*private\\s+"+m+"\\s*\\("))){return i}}return -1}function replaceMethodByLine(t,startLine,newMethod){const lines=t.split("\n");let depth=0,endLine=startLine;for(let i=startLine;i<lines.length;i++){for(const c of lines[i]){if(c==="{")depth++;else if(c==="}"){depth--;if(depth===0){endLine=i;break}}}if(depth===0)break}lines.splice(startLine,endLine-startLine+1,newMethod);return lines.join("\n")}const startLine=findMethodLine(s,"startCapture");if(startLine!==-1){s=replaceMethodByLine(s,startLine,"    private startCapture(): void {\n        console.log(`[WebRTCPeer][${this.sessionId}] Starting native capture`);\n        nativeCapture.start({\n            width: this.streamConfig.width,\n            height: this.streamConfig.height,\n            fps: this.streamConfig.fps,\n            bitrate: this.streamConfig.bitrate ?? 5000,\n            useHardwareEncoder: false\n        }, (nalBuffer: any) => {\n            this.processH264Data(nalBuffer);\n        });\n        console.log(`[WebRTCPeer][${this.sessionId}] Native capture started`);\n    }")}const stopLine=findMethodLine(s,"stopCapture");if(stopLine!==-1){s=replaceMethodByLine(s,stopLine,"    private stopCapture(): void {\n        if (nativeCapture?.stop) nativeCapture.stop();\n        this.h264Parser.clear();\n        console.log(`[WebRTCPeer][${this.sessionId}] Native capture stopped`);\n    }")}fs.writeFileSync(__dirname+"/../src/webrtc-peer.ts",s);console.log("PATCH_OK");
