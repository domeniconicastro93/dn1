<!DOCTYPE html>
<html>

<head>
    <title>WebRTC Stats Test</title>
</head>

<body>
    <h2>WebRTC Video Stats</h2>
    <button id="startBtn" onclick="startStream()">Start Stream</button>
    <video id="remoteVideo" autoplay playsinline muted style="width:640px;height:480px;background:#000;"></video>
    <div id="stats" style="font-family:monospace;white-space:pre-wrap;"></div>

    <script>
        let pc;
        const sessionId = 'browser-' + Date.now();
        const serverUrl = 'http://localhost:3015';

        async function startStream() {
            // Create peer connection
            pc = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            // Handle remote track
            pc.ontrack = (event) => {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
                console.log('✓ Track received');

                // Start stats monitoring
                setInterval(async () => {
                    const stats = await pc.getStats();
                    let framesDecoded = 0, packetsReceived = 0, bytesReceived = 0;

                    stats.forEach(report => {
                        if (report.type === 'inbound-rtp' && report.kind === 'video') {
                            framesDecoded = report.framesDecoded || 0;
                            packetsReceived = report.packetsReceived || 0;
                            bytesReceived = report.bytesReceived || 0;
                        }
                    });

                    document.getElementById('stats').textContent =
                        `Frames Decoded: ${framesDecoded}\n` +
                        `Packets Received: ${packetsReceived}\n` +
                        `Bytes Received: ${bytesReceived}`;
                }, 1000);
            };

            // Request offer
            const res1 = await fetch(`${serverUrl}/webrtc/session/${sessionId}/start`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ width: 1280, height: 720, fps: 30, bitrate: 3000 })
            });
            const { offer } = await res1.json();
            await pc.setRemoteDescription(offer);

            // Create answer
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            // Send answer
            await fetch(`${serverUrl}/webrtc/session/${sessionId}/answer`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ answer })
            });

            // Send ICE
            pc.onicecandidate = async (event) => {
                if (event.candidate) {
                    await fetch(`${serverUrl}/webrtc/session/${sessionId}/ice`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ candidate: event.candidate })
                    });
                }
            };

            console.log('✓ Stream started:', sessionId);
        }
    </script>
</body>

</html>